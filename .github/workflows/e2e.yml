name: E2E Tests

on: [push, pull_request]

jobs:
  e2e:
    runs-on: ubuntu-24.04
    name: Playwright E2E Tests
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: true
        fetch-depth: 0

    - name: Install apt dependencies
      # gettext is needed as Django uses msgfmt to compile MO files
      run: |
        sudo apt update
        sudo apt install gettext

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: '3.12'

    - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      with:
        cache-suffix: e2e
        version: 0.10.2

    - name: Install pip dependencies
      run: uv pip install --system -r requirements-dev.txt

    - name: Install Playwright browsers
      run: playwright install --with-deps chromium

    - name: Compile MO files
      run: ./scripts/generate-locales

    - name: Collect static files
      run: ./manage.py collectstatic --noinput

    - name: Create database
      run: ./manage.py migrate

    - name: Sync packages
      run: ./manage.py sync_packages

    - name: Run E2E tests
      env:
        DJANGO_ALLOW_ASYNC_UNSAFE: "true"
      run: |
        pytest weblate_web/tests_e2e/ -v --screenshot=only-on-failure --video=retain-on-failure

    - name: Upload test artifacts
      uses: actions/upload-artifact@ea4a91620b27f72b2d07c0f69f9cfd71fce71f5d # v4.6.2
      if: failure()
      with:
        name: playwright-traces
        path: |
          test-results/
          playwright-report/
        retention-days: 7

permissions:
  contents: read
